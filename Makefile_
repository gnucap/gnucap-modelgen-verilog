
MODELGEN = ../gnucap-mg-vams
MG_ENV = GNUCAP_PLUGPATH=..
GNUCAP_CONF = gnucap-conf

CXX = $(shell $(GNUCAP_CONF) --cxx)
GNUCAP_CPPFLAGS = $(shell $(GNUCAP_CONF) --cppflags) -DADD_VERSION -DPIC
GNUCAP_CXXFLAGS = $(shell $(GNUCAP_CONF) --cxxflags)
GNUCAP_LDFLAGS = $(shell $(GNUCAP_CONF) --ldflags)
GNUCAP_LIBDIR = $(shell $(GNUCAP_CONF) --libdir)
GNUCAP_LIBS = $(shell $(GNUCAP_CONF) --libs)
GNUCAP_PKGLIBDIR = $(shell $(GNUCAP_CONF) --pkglibdir)
GNUCAP_EXEC_PREFIX = $(shell $(GNUCAP_CONF) --exec-prefix)


%.so: %.o
	${CXX} -shared ${GNUCAP_CXXFLAGS} ${CXXFLAGS} $< -o $@

%.o: %.cc
	${CXX} $(GNUCAP_CPPFLAGS) $(CPPFLAGS) ${MAKE_CPPFLAGS} -fPIC ${GNUCAP_CXXFLAGS} ${CXXFLAGS} $< -o $@ -c

%.s: %.cc
	${CXX} -S ${GNUCAP_CPPFLAGS} ${CPPFLAGS} ${MAKE_CPPFLAGS} -DNDEBUG -O2 -fPIC ${GNUCAP_CXXFLAGS} ${CXXFLAGS} $< -o $@

%.cc: %.vams ${MODELGEN}
	${MG_ENV} ${MODELGEN} -I .. --cc $< > $@

%.pp: %.vams ${MODELGEN}
	${MG_ENV} ${MODELGEN} -I .. --pp $< > $@

all: ${TARGET}

clean:
	rm -r -f ${TARGET} ${TARGET:.so=.o} ${CLEANFILES}

install: ${TARGET}
	install -d $(DESTDIR)$(GNUCAP_PKGLIBDIR)/${PACKAGE}
	install $(TARGET) $(DESTDIR)$(GNUCAP_PKGLIBDIR)/${PACKAGE}

depend: Make.depend
Make.depend: $(SRCS) $(HDRS)
	$(CXX) -MM $(CXXFLAGS) ${GNUCAP_CPPFLAGS} ${CPPFLAGS} ${MAKE_CPPFLAGS} $(SRCS) > Make.depend
#-----------------------------------------------------------------------------

.PHONY: clean install
.SECONDARY: ${TARGET:.so=.cc}
.DELETE_ON_ERROR:
