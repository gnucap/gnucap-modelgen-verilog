# tests MakeBase
#
ENV = GNUCAP_PLUGPATH=${top_builddir}:$(plugpath) top_srcdir=${top_srcdir} srcdir=${srcdir} \
      LD_LIBRARY_PATH=${GNUCAP_LIBDIR}${LD_LIBRARY_PATH:%:%}

glob_dump = $(shell cd ${srcdir}; ls dump*.vams)
glob_pp = $(shell cd ${srcdir}; ls *.vapp)
glob_mg = $(shell cd ${srcdir}; ls mg*.gc)
glob_gc = $(shell cd ${srcdir}; ls u*.gc v*.gc)
glob_sh = $(shell cd ${srcdir}; ls *.sh)

filt_dump = $(filter ${TESTCASES}%, ${glob_dump})
filt_pp   = $(filter ${TESTCASES}%, ${glob_pp})
filt_mg   = $(filter ${TESTCASES}%, ${glob_mg})
filt_gc   = $(filter ${TESTCASES}%, ${glob_gc})
filt_sh   = $(filter ${TESTCASES}%, ${glob_sh})

dump_out = ${filt_dump:%=${TARGETDIR}/%.out}
dump_diff = ${filt_dump:%=${TARGETDIR}/%.diff}

pp_out = ${filt_pp:%=${TARGETDIR}/%.out}
pp_diff = ${filt_pp:%=${TARGETDIR}/%.diff}

mg_out = ${filt_mg:%=${TARGETDIR}/%.out}
gc_out = ${filt_gc:%=${TARGETDIR}/%.out}

all_gc_out = ${mg_out} ${gc_out}
gc_diff = ${all_gc_out:%.out=%.diff}

sh_out = ${filt_sh:%=${TARGETDIR}/%.out}
sh_diff = ${filt_sh:%=${TARGETDIR}/%.diff}

diff = ${dump_diff} ${gc_diff} ${pp_diff} ${sh_diff}

# TODO: maybe cat the diff, so it can be logged?
check: ${TARGETDIR}/${TESTCASES}.diff
	@find ${TARGETDIR} -size 0 -delete;
	@echo ==
	@if [ -s ${TARGETDIR}/${TESTCASES}.diff ]; then \
		echo test failures:; \
		ls -larS ${TARGETDIR}/${TESTCASES}*.diff; \
	else \
		echo all ${TESTCASES} passed; \
	fi

${TARGETDIR}/${TESTCASES}.diff : ${diff}
	@cat $+ > $@

${all_gc_out}: ${TEST_PLUGINS} ${SYMLINKS}

# this is a hack: link *.o
modelgen_0.so: modelgen_0.cc ../src/gnucap-mg-vams
	${CXX} -shared -fPIC ${GNUCAP_CPPFLAGS} ${CPPFLAGS} ${MAKE_CPPFLAGS} ${GNUCAP_CXXFLAGS} ${CXXFLAGS} $< ../src/*.o -o $@ # makefile.in
modelgen_1.so: modelgen_1.cc ../src/gnucap-mg-vams
	${CXX} -shared -fPIC ${GNUCAP_CPPFLAGS} ${CPPFLAGS} ${MAKE_CPPFLAGS} ${GNUCAP_CXXFLAGS} ${CXXFLAGS} $< ../src/*.o -o $@ # makefile.in

${diff}: ${TARGETDIR}/%.diff: ${TARGETDIR}/%.out
	@if [ ! -f ${ref}/$*.out ]; then \
	  echo MISS: $*; \
	  echo "missing: $*.out" > $@; \
	elif ${DIFF} ${ref}/$*.out ${TARGETDIR}/$*.out > $@; then \
	  echo pass: $*; \
	else \
	  echo FAIL: $*; \
	fi

# makefile: makefile.in
# 	source config.log
#
prep: ${SYMLINKS}
	# @[ ! -s "${TARGETDIR}" ]
	-mkdir -p ${TARGETDIR}

${mg_out}: ${TARGETDIR}/mg%.gc.out: prep
	-@${ENV} ${GNUCAP} ${GNUCAP_ARGS} ${MG_ARGS} ${srcdir}/mg$*.gc |tail -n +12 | \
		grep -v '^stashing\ as' | grep -v 'already\ installed' | grep -v ^make > $@

${gc_out}: ${TARGETDIR}/%.gc.out: prep
	-@${ENV} ${GNUCAP} ${GNUCAP_ARGS} ${srcdir}/$*.gc |tail -n +12 | \
		grep -v '^stashing\ as' | grep -v 'already\ installed' | grep -v ^make > $@

${pp_out}: ${TARGETDIR}/%.vapp.out: prep
	@[ x${srcdir} = x. ] || ln -sf ${srcdir}/$*.vapp;
	@${ENV} ${MODELGEN} -d ${TARGETDIR}/$*.err -I${srcdir} -D__VAMS_GNUCAP --pp $*.vapp | cat > $@
	@[ x${srcdir} = x. ] || rm $*.vapp;
	@cat ${TARGETDIR}/$*.err >> $@
	@rm ${TARGETDIR}/$*.err

${dump_out}: ${TARGETDIR}/%.vams.out: prep
	@[ x${srcdir} = x. ] || ln -sf ${srcdir}/$*.vams;
	@${ENV} ${MODELGEN} -d ${TARGETDIR}/$*.err -I${top_srcdir}/vams --dump $*.vams | cat > $@
	@[ x${srcdir} = x. ] || rm $*.vams;
	@cat ${TARGETDIR}/$*.err >> $@
	@rm ${TARGETDIR}/$*.err

${sh_out}: ${TARGETDIR}/%.sh.out: prep
	-@${ENV} ${srcdir}/$*.sh ${MODELGEN} > $@

${PWD}/disciplines.vams:
	-${LN_S} ${top_srcdir}/vams/disciplines.vams
${PWD}/constants.vams:
	-${LN_S} ${top_srcdir}/vams/constants.vams
${PWD}/sub:
	-${LN_S} ${srcdir}/sub
